import json
import urllib

from django.core import serializers
from django.http import HttpResponse, Http404
from django.shortcuts import render

from wines import greedy_tsp
from wines.models import Wine, WineProducer

def root(request):
    """Generate the main page"""
    return render(request, 'root.html') 

def about(request):
    """Generate the about page"""
    return render(request, 'about.html') 

def search(request):
    """Generate the search page"""
    return render(request, 'search.html') 

def search_basic(request):
    """Generate the search page"""
    return render(request, 'search_basic.html') 

def calculate(request):
    """Calculate optimal wine tour routes"""
    tsp_input = parse_query_string(request.META['QUERY_STRING'])
    routes = []
    #Populate routes with greedy_tsp
    #IMPORTANT
    #`routes` should be an ordered list of tuples, in order of best route to worst
    #Each tuple is of the following form:
    #(<start_address>, <end_address>, [list of stops IN ORDER that they are vistied])
    #See below for example
    routes.append(
	    ('2899 Joyce Lane, Merrick, NY, 11566', 
		'2899 Joyce Lane, Merrick, NY, 11566',
		['55 Ridgewood Road, Ithaca, NY 14850']))
    routes.append(
	    ('Amazon Headquarters, Seattle, WA 98119',
		'Amazon Headquarters, Seattle, WA 98119',
		['Space Needle, Seattle, WA 98119']))
    routes.append(
	    ('1600 Ampitheathre Parkway, Mountain View, CA 94043',
		'Amazon Headquarters, Seattle, WA 98119',
		['Space Needle, Seattle, WA 98119']))

    return HttpResponse(json.dumps(routes), content_type='application/json')

def query(request):
    """Queries the database for basic filter results, returns JSON response"""
    query_args = request.META['QUERY_STRING'].split('&')
    if not query_args[0]: query_args = query_args[1:]
    kwargs = {}
    for arg in query_args:
	k, v = arg.split('=')
	kwargs[k] = urllib.unquote(v)
    results = None
    try:
	results = Wine.objects.filter(**kwargs)
    except Wine.DoesNotExist:
	raise Http404
    except ValueError:
	results = []
    return HttpResponse(
		serializers.serialize('json', results, use_natural_keys=True), 
		content_type='application/json')

def parse_query_string(string):
    """Parses a query string into a usable form for greedy_tsp"""
    pass
